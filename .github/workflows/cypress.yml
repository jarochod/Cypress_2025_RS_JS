name: Cypress E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  cypress:
    runs-on: ubuntu-latest
    
    # 1. U≈ºycie gotowego obrazu Cypress
    # Wybieramy obraz z Node i Cypress, kt√≥ry bƒôdzie ≈õrodowiskiem dla joba.
    container:
      # U≈ºyjemy obrazu od Cypress, kt√≥ry jest optymalny do uruchamiania test√≥w E2E
      image: cypress/base:22
      env:
        # Przekazywanie zmiennych ≈õrodowiskowych (w tym Secret) bezpo≈õrednio do kontenera
        BASE_URL: http://localhost:2221/
        ADMIN_USERNAME: admin
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
    
    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup and Run Cypress Tests
      # Wszystkie polecenia wykonujƒÖ siƒô wewnƒÖtrz kontenera z obrazu cypress/base:22
      run: |
        echo "Install dependencies from lockfile"
        # Instalacja zale≈ºno≈õci NPM
        npm ci
        
        echo "Start the shopping store application"
        # 1. Nadanie uprawnie≈Ñ i uruchomienie aplikacji w tle (operator &)
        chmod +x ./shopping-store/shopping-store-linux-amd64
        ./shopping-store/shopping-store-linux-amd64 &
        
        # 2. Daj aplikacji czas na uruchomienie (krytyczne dla stabilno≈õci)
        echo "Waiting 10 seconds for app to start..."
        sleep 10
        
        echo "Run Cypress tests"
        # 3. Uruchomienie test√≥w Cypress
        # U≈ºyjemy polecenia, kt√≥re masz w swoim package.json (npm run test:ci)
        npm run test:ci

